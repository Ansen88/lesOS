# lesOS

`lesOS` （`lightweight easy simple OS`）是专门为`arduino`设计的一款轻量级简单易用的操作系统。目前已经在 `Arduino Pro Mini `（`ATmega328P @ 5V`）进行测试。



# 系统介绍

`lesOS`是专门为小内存的嵌入式 `MCU `设计的操作系统。

***系统不带有动态内存管理***

因为在系统中不能使用 `malloc/free` 等具有动态内存操作的函数，而使用了静态数组来作为替代；所以在开发初期要提前对项目的功能进行规划，从而使数组的容量能够满足项目的要求。例如，在定时器中对每个任务都分配了一个结构体；当一个任务要进行延迟时定时器就使用对应的结构体来保存相关参数。

***基于优先级的简单调度器***

系统中带有一个优先级汇总，长度为单字节（8 bits）——其中每一位对应一个优先级，最多8个优先级。当一个任务对应的优先级置位，则表示该优先级对应的任务准备就绪；在下次调度时就会从这些就绪的任务中选择优先级最高的任务去运行。

该系统是针对小内存的 `MCU` 所以系统设计时并没有给每个任务分配相应的堆栈，因此虽然该系统带有基于优先级的调度器，却不是抢占式操作系统——调度发生的时机是在一个任务返回/退出后；所以在任务设计上推荐使用状态机模式：将任务分解为多个小阶段；当每个小阶段结束后都返回调度器这样就可以满足一定实时性要求。

***定时功能***

系统中提供了延迟函数。任务可以通过延迟函数为自己进行阻塞/非阻塞的延迟操作。当处于阻塞的延迟时，如果任务返回调度则该任务会处于阻塞状态不再被调度；在延迟结束后再将自己解除阻塞重新被调度——这样就可以提高`MCU`的利用率。

***简单的任务管理***

系统的任务目前只有一个`block`标志，用于配合调度器进行调度。

***简单的电源管理***

当调度器没有获取到任何就绪的任务时，就会进入低功耗状态。通过修改睡眠标志（例如："SLEEP_MODE_IDLE"  ），可以更改进入低功耗的级别。

# 测试

目前通过在系统中通过创建 “test“任务和“bleed”任务，在每个任务中通过定时器延迟一定的时间后打印一条信息来进行测试。

```shell
15:40:54.436 -> [test:] loop(true)
15:40:55.693 -> [test:] loop(true)
15:40:55.693 -> [Bleed:] loop(true)
15:40:56.954 -> [test:] loop(true)
15:40:58.210 -> [test:] loop(true)
15:40:58.211 -> [Bleed:] loop(true)
15:40:59.470 -> [test:] loop(true)
15:41:00.727 -> [test:] loop(true)
15:41:00.727 -> [Bleed:] loop(true)
15:41:01.953 -> [test:] loop(true)
15:41:03.211 -> [test:] loop(true)
15:41:03.211 -> [Bleed:] loop(true)
15:41:04.464 -> [test:] loop(true)
15:41:05.719 -> [test:] loop(true)
15:41:05.719 -> [Bleed:] loop(true)
15:41:06.978 -> [test:] loop(true)
```



# 使用

***创建任务文件***

参考`lesOS`项目中的 `test` 相关代码。

***修改相关代码***

+ 在 `task.h`文件中的`enum task_id_number`枚举中添加任务对应的`ID` ;
+ 在主文件`lesOS.ino`中的`loop()`中添加相应的分支和代码；